## 4.2 模型供应商接入与认证方式

本节围绕 `models.providers` 讲清三件事：provider 与 model 的命名与关联；API 密钥如何通过 `${VAR_NAME}` 占位符注入从而避免明文落盘；多密钥与 `keyId` 如何支撑轮换与灰度。最后给出一套可复制的验收命令，确保"可用且可替换"。

### 4.2.1 概念拆分：provider 与 model 的层级

在 OpenClaw 里，供应商配置集中在 `models.providers`：它解决"怎么连、用什么凭据连"。注意：

- **内置供应商**（OpenAI、Anthropic、Moonshot 等）的密钥通常由 `openclaw onboard` 向导写入 `~/.openclaw/agents/<agentId>/agent/auth-profiles.json`，无需在 `openclaw.json` 中手动配置。
- **自定义/自托管供应商**（如 OpenRouter 或自建代理）才需要在 `models.providers` 里声明连接信息与 baseURL。

真正的调用目标由 `provider/model` 形式的模型标识决定，例如：`openai/gpt-5.2`、`anthropic/claude-sonnet-4-6`。

两者的关联只有一条规则：模型标识里斜杠前的 `provider`，必须能在 `models.providers` 里找到同名的 provider 配置（自定义 provider）或已存入认证档案（内置 provider）。

一个最小示例（把"接入"与"选用"放在同一张图里）：

```json5
{
  models: {
    providers: {
      openai: { apiKey: "${OPENAI_API_KEY}" },
      anthropic: { apiKey: "${ANTHROPIC_API_KEY}" },
    },
  },

  agents: {
    defaults: {
      model: {
        primary: "openai/gpt-5.2",
      },
    },
  },
}
```

常见的命名形态（用于帮助你理解层级，不要求你一次记住所有模型名）：

- `openai/gpt-5.2`、`openai/gpt-5-mini`
- `anthropic/claude-sonnet-4-5`
- `moonshot/kimi-k2.5`
- `minimax/MiniMax-M2.5`
- `zai/glm-5`

你在本章要确保的是：provider 连接与认证可用；而“到底选哪个模型”属于 4.3 的策略问题。

### 4.2.2 密钥注入：优先使用 ${} 占位符而不是明文

配置支持在字符串字段里写 `${VAR_NAME}`，运行时会从环境变量（或 `.env` 文件）读取真实值。推荐把密钥放进环境变量或密钥系统，在配置里只写 `${}` 占位符：这样配置文件可入库、可审计、可复现，但密钥不落盘。

配置示例（单密钥）：

```json5
{
  models: {
    providers: {
      openai: {
        apiKey: "${OPENAI_API_KEY}",
      },
      anthropic: {
        apiKey: "${ANTHROPIC_API_KEY}",
      },
    },
  },
}
```

本地设置环境变量（示例）：

```bash
export OPENAI_API_KEY="..."
export ANTHROPIC_API_KEY="..."
```

也可以把密钥写入 `~/.openclaw/.env`（或工作目录下的 `.env`），系统会自动读取：

```bash
OPENAI_API_KEY=...
ANTHROPIC_API_KEY=...
```

验收点：配置文件中不出现明文密钥；`models status --check` 能通过；结构化日志与诊断输出不打印明文密钥。

### 4.2.3 多密钥与 keyId：为轮换与灰度预留结构

同一 provider 可以配置多把密钥，用 `keyId` 选择默认密钥。建议把"新增密钥"与"切换默认"拆成两个动作：先新增并小流量验证，再切换 `keyId`，最后吊销旧密钥。

配置示例（多密钥）：

```json5
{
  models: {
    providers: {
      openai: {
        keys: {
          primary: {
            apiKey: "${OPENAI_API_KEY_PRIMARY}",
          },
          secondary: {
            apiKey: "${OPENAI_API_KEY_SECONDARY}",
          },
        },
        keyId: "primary",
      },
    },
  },
}
```

轮换建议：不要在故障窗口直接"替换同一个环境变量的值"，那会让排障证据变得不可追溯；更稳的是新增一把钥匙、切换 `keyId`、保留旧钥匙一段观测窗口后再回收。

### 4.2.4 接入验收：用 models status 做可观测验证

配置完成后用一组最小命令做验收（只看结果，不靠感觉）：

```bash
openclaw doctor
openclaw models status --check
openclaw status --deep
```

- `doctor` 失败：先修复“配置可读”与“运行依赖”，不要先调提示词或工作流。
- `models status --check` 失败：优先检查环境变量是否存在、`${}` 占位符的变量名是否拼对、provider 配置是否写在 `models.providers` 下。
- `status --deep` 中看不到预期的 provider/model：优先回看层级（`models.providers` 与 `agents.defaults.model` 是否写在正确位置）。

## 6.3 记忆机制：写入、检索与失效

本节以官方记忆系统为准讲清“记忆存在哪里、怎样被检索、怎样避免污染”。OpenClaw 的长期记忆以工作区文件为中心，并配套向量索引与内置记忆工具（例如 `memory_search`、`memory_get`）。掌握这些机制后，才能把记忆从“越积越乱”变成“可维护资产”。

### 6.3.1 记忆落盘结构：MEMORY.md 与每日日志

官方约定的工作区结构里，长期记忆与日志是明确分离的。参考：[记忆](https://docs.openclaw.ai/concepts/memory)。

- `MEMORY.md`：精选长期记忆，放在工作区根目录，仅在私聊主会话中加载，不在群聊上下文中注入。
- `memory/YYYY-MM-DD.md`：每日追加日志，会话启动时读取当天与前一天的记录。

这种设计的工程意义是：把“可复用事实”与“过程噪声”分开，让检索与注入保持信噪比。

### 6.3.2 写入规则：只写稳定、可追溯、可纠错

记忆写入最常见的失败是把猜测当事实。建议把写入规则写成硬约束。

- 稳定：跨会话复用，短期不易过期。
- 可追溯：来自工具回执或明确来源，而不是模型推测。
- 可纠错：允许撤销与替换，不把错误永久固化。

**具体例子：好记忆与坏记忆的对比**

- ❌ **坏记忆（模型的主观推测或短时状态）**：“用户今天好像心情不好，并且似乎遇到了线上麻烦。” 这种记忆会在明天变得毫无意义，只会白白占据上下文空间并干扰未来的问询基调。
- ✅ **好记忆（客观、可追溯的事实约束）** ：“用户偏好使用 Python 编写运维脚本（来源：2月20日对话，用户要求全用 Python）；当前工作区 Kubernetes 生产集群名为 `prod-cluster-us`。”

操作示例：在 `MEMORY.md` 用结构化小节记录事实，并附带来源与更新时间；在 `memory/YYYY-MM-DD.md` 记录过程性日志。

```md
## 部署区域

- 结论：生产环境部署在 us-east-1
- 来源：变更单 CHG-12345
- 更新时间：YYYY-MM-DD
```

### 6.3.3 检索机制：memory_search 与 memory_get

官方记忆工具提供两类取数。

- 搜索：`memory_search` — 按语义或关键字在索引库中检索相关片段。
- 精确读取：`memory_get` — 按引用定位到某个记忆文件的指定行范围。

操作要点：检索结果要少而精。把大量候选一次性注入上下文，会让模型“以为每条都重要”，反而降低决策质量。

### 6.3.4 失效与清理：让记忆有生命周期

长期系统一定会遇到“事实过期”。建议为每条记忆补齐“来源/更新时间/有效期”，并定期做一次复核：过期则标注失效或迁移到每日日志；新事实覆盖旧事实时保留变更链；遇到冲突事实显式标注冲突点，避免模型自行选择。

- 过期条目标注失效或迁移到每日日志。
- 新事实覆盖旧事实时保留变更链。
- 对冲突事实显式标注冲突点，避免模型自行选择。


# 第十章 Agent Loop 运行内核剖析

本章聚焦 Agent Loop 的执行主链：请求如何进入、上下文如何组装、工具如何被调度、结果如何流式返回。理解这条主链，是深入架构设计、定位复杂故障与优化执行效率的关键所在。

在深入代码细节之前，我们需要先建立一个心智模型：**OpenClaw 让任务实现长程运行、可中断、随时恢复的秘密，并不在于大模型有多聪明，而在于其底层直接建立在极其克制的 π（pi）运行底座之上。**

本章围绕上述架构底座的执行链路展开，依次剖析每个核心组件的运作原理与工程设计。

## 本章学习目标

本章内容将涵盖以下核心机制，包括排队控制、提示词工程、工具调度以及状态流式管理。

- **[10.1 π 运行底座：重构智能体的心智模型](10.1_pi_framework.md)**：剖析事件、状态机、执行内核三位一体的工作模式。
- **[10.2 入口、排队与并发控制](10.2_entry_queue.md)**：理解事件排队、槽位预算背后的状态机防崩溃机制。
- **[10.3 提示词装配框架机制与结构化注入防护](10.3_prompt_assembly.md)**：掌握提示词结构化装配过程，理解基于 Token 预算的裁剪折叠算法。
- **[10.4 工具执行挂起（Suspend/Resume）与深层流转](10.4_tool_execution.md)**：深挖工具调度时的 Suspend/Resume 挂起机制，并预防上下文“遗忘灾难”。
- **[10.5 流式输出、重试与提前终止](10.5_streaming_retry.md)**：建立在 Event Stream 之上的重试退避机制与日志追踪范式。
- **[10.6 本章小结](summary.md)**：总结核心运行底层机制，并为后续控制边界与安全机制做好衔接。

## 阅读建议

本章属于“深水区”，建议在阅读时对照自己脑海中的传统中间件架构，思考 Agent 模式为什么必须要把“状态管理”推向极致。并在本地跑起最小用例，打开结构化日志观测状态转移。
